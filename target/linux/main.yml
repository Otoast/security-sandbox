---
################################################################################
# TARGET MACHINE SETUP - ELASTIC AGENT DEPLOYMENT
################################################################################
#
# Purpose:
#   This playbook deploys Elastic Agent to target machines for security
#   monitoring and log collection. Agents automatically enroll with the
#   Fleet Server and begin sending data to the logging server.
#
# What gets collected:
#   - System logs (syslog, auth logs, etc.)
#   - Process events (executions, network connections)
#   - File changes and integrity monitoring
#   - Network traffic metadata
#   - Security events (authentication, privilege escalation)
#
# Architecture:
#   Target Machine (This playbook)
#   └── Elastic Agent
#       ├── Enrolls with Fleet Server (port 8220)
#       ├── Receives policy from Fleet
#       ├── Collects logs and metrics
#       └── Sends data to Elasticsearch
#
# Prerequisites:
#   - Linux machine (Ubuntu/Debian or RHEL/CentOS)
#   - Minimum 512MB RAM, 1 CPU core
#   - Network connectivity to Fleet Server (port 8220)
#   - SSH access with sudo privileges
#   - Python 3 installed on target
#   - Logging server must be deployed first!
#
# Credentials:
#   This playbook automatically reads credentials from:
#   ../../.fleet_credentials.yml
#   
#   This file is generated by the logging server playbook and contains:
#   - Fleet Server URL
#   - Enrollment token
#   - Elasticsearch/Kibana URLs
#
# Usage:
#   1. Ensure logging server is deployed first
#   2. Update target_linux.ini with your target machine IPs
#   3. Run: ansible-playbook -i target_linux.ini main.yml
#   4. Agents will automatically enroll and appear in Kibana Fleet UI
#
# Verification:
#   - Check Kibana → Management → Fleet → Agents
#   - Verify agent shows as "Healthy"
#   - Check Kibana → Discover for incoming logs
#
# Estimated Runtime: 3-5 minutes per machine
#
################################################################################

- name: Target Machine Setup (Linux) - Elastic Agent Only
  hosts: target_linux
  become: yes
  vars:
    # Version Configuration
    # Note: Should match the version on the logging server
    elastic_agent_version: "9.1.5" # Can update with any version if needed (watch for compatibility!)
    
    # Security Configuration
    # Set to true to skip TLS certificate verification
    # ⚠️  Not recommended for production, but useful for testing with self-signed certs
    insecure: true
  
  vars_files:
    # Automatically loads Fleet credentials from logging server deployment
    # File path is relative to this playbook's location
    - ../../.fleet_credentials.yml

  tasks:
    ############################################################################
    # PHASE 1: CREDENTIAL VERIFICATION
    ############################################################################
    # Ensures that the logging server has been deployed and credentials exist
    ############################################################################
    
    - name: Verify Fleet credentials are loaded
      assert:
        that:
          - fleet_server_url is defined
          - fleet_enrollment_token is defined
        fail_msg: |
          ❌ Fleet credentials not found! 
          
          The file ../../.fleet_credentials.yml does not exist or is invalid.
          
          You must run the logging server playbook first:
          cd ../../logging/linux
          ansible-playbook -i logging_server.ini main.yml
          
          This will generate the .fleet_credentials.yml file needed for target enrollment.
          
        success_msg: "✅ Fleet credentials loaded successfully from .fleet_credentials.yml"
      # This check prevents deployment failures if logging server isn't set up

    ############################################################################
    # PHASE 2: ELASTIC AGENT INSTALLATION
    ############################################################################
    # Downloads and extracts the Elastic Agent software
    ############################################################################
    
    - name: Elastic Agent Download and Extract
      tasks:
        - name: Obtain Elastic Agent Setup TAR
          get_url:
            url: "https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-{{ elastic_agent_version }}-linux-x86_64.tar.gz"
            dest: "/tmp/elastic-agent.tar.gz"
          # Downloads ~200MB from Elastic's official repository
          
        - name: Extract Elastic Agent
          unarchive:
            src: "/tmp/elastic-agent.tar.gz"
            dest: "/opt/"
            remote_src: yes
          # Extracts to /opt/elastic-agent-<version>-linux-x86_64/

    ############################################################################
    # PHASE 3: FLEET ENROLLMENT
    ############################################################################
    # Installs agent as a system service and enrolls it with Fleet Server
    ############################################################################
    
    - name: Elastic Agent Install and Enroll to Fleet Server
      tasks:
        - name: Install Elastic Agent with Fleet enrollment
          shell: |
            cd /opt/elastic-agent-{{ elastic_agent_version }}-linux-x86_64
            ./elastic-agent install \
              --url={{ fleet_server_url }} \
              --enrollment-token={{ fleet_enrollment_token }} \
              {% if insecure %}--insecure{% endif %}
          args:
            creates: /opt/Elastic/Agent/elastic-agent
          register: agent_install
          # Installation process:
          # 1. Installs agent as systemd service
          # 2. Connects to Fleet Server at specified URL
          # 3. Authenticates using enrollment token
          # 4. Downloads policy from Fleet Server
          # 5. Starts data collection based on policy
          # 6. Begins sending data to Elasticsearch
          #
          # The --insecure flag skips TLS verification (useful for self-signed certs)
          # In production, remove this flag and use proper certificates

        - name: Check Elastic Agent status
          command: elastic-agent status
          register: agent_status
          ignore_errors: yes
          # Retrieves current status of the agent
          # Shows: connection state, policy info, component health

        - debug:
            msg: |
              ============================================
              ELASTIC AGENT INSTALLATION COMPLETE
              ============================================
              Fleet Server: {{ fleet_server_url }}
              Enrollment: Automatic (token from logging server)
              
              Agent Status:
              {{ agent_status.stdout }}
              
              ✅ Agent is now collecting data and sending to Elasticsearch
              
              View this agent in Kibana:
              {{ kibana_url }}/app/fleet/agents
              
              View collected logs:
              {{ kibana_url }}/app/discover
              ============================================

################################################################################
# POST-DEPLOYMENT NOTES
################################################################################
#
# What's Running:
# └── Elastic Agent (systemd service: elastic-agent)
#     ├── Enrolled with Fleet Server
#     ├── Collecting system logs
#     ├── Monitoring processes and network
#     └── Sending data to Elasticsearch
#
# Verification Steps:
# 1. Check agent status on target machine:
#    sudo elastic-agent status
#
# 2. View logs if troubleshooting needed:
#    sudo journalctl -u elastic-agent -f
#
# 3. In Kibana, go to: Management → Fleet → Agents
#    - Agent should appear with "Healthy" status
#    - Click agent name to see details and logs
#
# 4. View collected data: Kibana → Discover
#    - Select data view: logs-*
#    - Filter by host.name: <this-machine>
#
# Agent Management:
# - Uninstall: sudo elastic-agent uninstall
# - Restart: sudo systemctl restart elastic-agent
# - Status: sudo elastic-agent status
# - Logs: sudo journalctl -u elastic-agent
#
# What Data is Collected (Default Policy):
# ├── System Logs
# │   ├── /var/log/syslog
# │   ├── /var/log/auth.log
# │   └── /var/log/messages
# ├── System Metrics
# │   ├── CPU, Memory, Disk usage
# │   └── Network interface statistics
# └── Security Events (if auditd is installed)
#     ├── File access attempts
#     ├── User authentication events
#     └── Process executions
#
# Customizing Data Collection:
# 1. In Kibana, go to: Management → Fleet → Agent policies
# 2. Click the policy assigned to this agent
# 3. Add integrations for additional data sources:
#    - Auditd (Linux security events)
#    - File Integrity Monitoring
#    - Network Packet Capture
#    - Custom log files
#    - Application-specific logs
#
# Troubleshooting:
# - Agent not appearing in Fleet?
#   → Check network connectivity to port 8220
#   → Verify enrollment token is valid
#   → Check agent logs: sudo elastic-agent logs
#
# - Agent shows "Offline"?
#   → Check if service is running: systemctl status elastic-agent
#   → Verify Fleet Server is accessible
#   → Check firewall rules
#
# - No data appearing in Elasticsearch?
#   → Verify agent policy is assigned
#   → Check agent components: elastic-agent status
#   → Look for errors in: sudo elastic-agent logs
#
################################################################################
